<!DOCTYPE html>
<html>
	<head>
		<title>THREECS | Demo</title>
		<script type="importmap">
			{
				"imports": {
					"three":           "https://unpkg.com/three@0.157.0/build/three.module.min.js",
					"three/addons/":   "https://unpkg.com/three@0.157.0/examples/jsm/",
					"three-ecs":       "../index.js",
					"three-ecs/":      "../"
				}
			}
		</script>
		<script type="module">
			import { 
				World, Entity, Component, System, 
				Camera, Geometry, Material, Mesh,
				componentRegistry, systemRegistry
			} from "three-ecs";


			// CUSTOM COMPONENTS
			// ---------------------------------------------
			class NoisyComponent extends Component {
				added(entity){
					super.added(entity);

					entity.addEventListener("SYSTEM__NOISY_SYSTEM__UPDATE", this.#handleNoisySystemUpdate);

					console.log("Noisy component added!");
				}// added

				#handleNoisySystemUpdate = event => {
					console.log("The noisy system told me to say something!");
				}// #handleNoisySystemUpdate
			}// NoisyComponent

			componentRegistry.set("noisy-component", NoisyComponent);


			// CUSTOM SYSTEMS
			// ---------------------------------------------
			class NoisySystem extends System {
				#interval;

				static get autoregister(){
					return [
						NoisyComponent.name
					]
				}// get autoregister

				constructor(){
					super();

					this.#interval = setInterval(this.update.bind(this), 1000);
				}// constructor

				added(entity){
					super.added(entity);

					console.log("Noisy system added!");
				}// added
				removed(entity){
					super.removed(entity);

					clearInterval(this.#interval);
				}// removed

				update(){
					for(const component of this.registeredComponents.values()){
						component.entity.dispatchEvent({
							type: "SYSTEM__NOISY_SYSTEM__UPDATE"
						});
					}
				}// update
			}// NoisySystem

			systemRegistry.set("noisy-system", NoisySystem);


			// BUILD-OUT SCENE
			// ---------------------------------------------
			const world = window.WORLD = new World(
				[
					// create a red box to the left
					new Entity(
						[], 
						[],
						[
							new Geometry(),
							new Material({ color: 0xff0000 }),
							new Mesh()
						],
						{
							position: {
								x: -2
							}
						}
					),
					// create a blue box to the right
					new Entity(
						[], 
						[],
						[
							new Geometry(),
							new Material({ color: 0x0000ff }),
							new Mesh()
						], 
						{
							position: {
								x: 2
							}
						}
					),
					new Entity(
						[],
						[],
						[ 
							new Camera(),
							new NoisyComponent()
						],
						{
							position: {
								y: 1,
								z: 5
							}
						}
					)
				],
				[
					new NoisySystem()
				], 
			);
			
			document.body.appendChild(world.canvas);

			world.connected();
			world.play();
		</script>
		<style>
			* {
				box-sizing: border-box;;
			}
			html, body, canvas {
				height: 100%;
				width: 100%;
			}
			body {
				margin: 0;
			}
		</style>
	</head>
	<body>

	</body>
</html>
